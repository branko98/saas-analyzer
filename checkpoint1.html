<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review URLs - SaaS Analyzer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: #f5f5f5;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #17305d 0%, #0f1f3d 100%);
      color: white;
      padding: 30px;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .instructions {
      padding: 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }
    
    .instructions h3 {
      margin-bottom: 10px;
      color: #17305d;
    }
    
    .instructions p {
      color: #666;
      font-size: 14px;
    }
    
    .content {
      padding: 30px;
    }
    
    .url-item {
      border: 2px solid #e0e0e0;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .url-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .url-item.recommended {
      border-color: #28a745;
      background: #f0fff4;
    }
    
    .url-item.decide {
      border-color: #ffc107;
      background: #fffbf0;
    }
    
    .url-item.selected {
      border-color: #17305d;
      background: #f0f4ff;
    }
    
    .url-item label {
      display: flex;
      align-items: flex-start;
      cursor: pointer;
    }
    
    .url-item input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 15px;
      margin-top: 2px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .url-content {
      flex: 1;
    }
    
    .url-header {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #17305d;
    }
    
    .url-link {
      display: inline-block;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #666;
      background: #f5f5f5;
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 8px;
      word-break: break-all;
    }
    
    .url-reasoning {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .badge-yes {
      background: #28a745;
      color: white;
    }
    
    .badge-decide {
      background: #ffc107;
      color: #333;
    }
    
    .badge-score {
      background: #17305d;
      color: white;
    }
    
    .submit-container {
      padding: 30px;
      background: #f8f9fa;
      border-top: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .selection-count {
      font-size: 14px;
      color: #666;
    }
    
    .selection-count strong {
      color: #17305d;
      font-size: 18px;
    }
    
    .submit-btn {
      background: #17305d;
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .submit-btn:hover {
      background: #0f1f3d;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(23, 48, 93, 0.3);
    }
    
    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .success-message {
      text-align: center;
      padding: 60px 30px;
    }
    
    .success-message h1 {
      color: #28a745;
      font-size: 36px;
      margin-bottom: 20px;
    }
    
    .success-message p {
      color: #666;
      font-size: 16px;
    }
    
    .error-message {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      color: #856404;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    @media (max-width: 600px) {
      body { padding: 10px; }
      .header { padding: 20px; }
      .header h1 { font-size: 22px; }
      .content { padding: 15px; }
      .submit-container { flex-direction: column; gap: 15px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìã Review URLs for Analysis</h1>
      <p id="client-info">Loading...</p>
    </div>
    
    <div class="instructions">
      <h3>üéØ Instructions:</h3>
      <p>‚úÖ <strong>Recommended</strong> pages are pre-selected. Review them carefully and uncheck any that don't seem relevant.</p>
      <p>ü§î <strong>Decide</strong> pages are not pre-selected. Check them if you want them analyzed.</p>
    </div>
    
    <div class="content">
      <form id="checkpoint-form">
        <div id="url-list"></div>
        
        <div class="submit-container">
          <div class="selection-count">
            Selected: <strong id="count">0</strong> URLs
          </div>
          <button type="submit" class="submit-btn" id="submit-btn">
            Submit Selection ‚Üí
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Parse data from URL parameter
    function loadData() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get('data');
        
        console.log('URL:', window.location.href);
        console.log('Encoded data length:', encodedData ? encodedData.length : 0);
        
        if (!encodedData) {
          throw new Error('No data parameter found in URL');
        }
        
        const data = JSON.parse(atob(encodedData));
        console.log('Parsed data:', data);
        return data;
      } catch (error) {
        console.error('Error loading data:', error);
        console.error('Error details:', error.message, error.stack);
        document.querySelector('.container').innerHTML = `
          <div class="error-message">
            <strong>‚ùå Error:</strong> Invalid or missing data. Please use the link from your email.
            <br><br>
            <details>
              <summary>Debug Info (click to expand)</summary>
              <pre style="text-align: left; font-size: 11px; margin-top: 10px;">${error.message}\n\nURL: ${window.location.href}\n\nData param exists: ${urlParams.get('data') ? 'YES' : 'NO'}</pre>
            </details>
          </div>
        `;
        return null;
      }
    }
    
    // Initialize page
    const data = loadData();
    if (!data) return;
    
    // Display client info
    document.getElementById('client-info').textContent = 
      `Client: ${data.client_name} | ${data.saas_url} | Session: ${data.session_id}`;
    
    // EDGE CASE: Zero URLs
    if (!data.urls || data.urls.length === 0) {
      document.querySelector('.container').innerHTML = `
        <div class="header">
          <h1>‚ö†Ô∏è No URLs Available</h1>
          <p>Session: ${data.session_id}</p>
        </div>
        <div class="content">
          <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 24px; border-radius: 8px; text-align: center;">
            <h3 style="color: #856404; margin-bottom: 16px;">Unable to Identify Pages for Analysis</h3>
            <p style="color: #856404; margin-bottom: 12px;">
              We were unable to find any product or feature pages on <strong>${data.saas_url}</strong>.
            </p>
            <p style="color: #856404; margin-bottom: 20px;">This could indicate:</p>
            <ul style="text-align: left; display: inline-block; color: #856404; margin-bottom: 24px;">
              <li style="margin: 8px 0;">The website has an unusual structure</li>
              <li style="margin: 8px 0;">Product information is embedded in JavaScript</li>
              <li style="margin: 8px 0;">The site blocks automated access</li>
              <li style="margin: 8px 0;">The URL provided was incorrect</li>
            </ul>
            <div style="background: white; padding: 20px; border-radius: 6px; margin-top: 20px;">
              <p style="color: #333; font-weight: 600; margin-bottom: 8px;">üìß Next Steps:</p>
              <p style="color: #666;">
                Please contact our support team at 
                <a href="mailto:ai-support@impactable.com" style="color: #17305d; font-weight: 600;">ai-support@impactable.com</a>
              </p>
              <p style="color: #999; font-size: 13px; margin-top: 16px;">
                Include your Session ID: <strong>${data.session_id}</strong>
              </p>
            </div>
          </div>
        </div>
      `;
      return; // Stop execution
    }
    
    // Render URL checklist
    const urlList = document.getElementById('url-list');
    let selectedCount = 0;
    
    data.urls.forEach((url, index) => {
      // Skip NO recommendations
      if (url.recommendation === 'NO') return;
      
      const itemDiv = document.createElement('div');
      const isRecommended = url.recommendation === 'YES';
      const checked = isRecommended ? 'checked' : '';
      
      itemDiv.className = `url-item ${isRecommended ? 'recommended' : 'decide'} ${checked ? 'selected' : ''}`;
      
      itemDiv.innerHTML = `
        <label>
          <input type="checkbox" name="url_${index}" value="${url.url}" data-url="${url.url}" ${checked}>
          <div class="url-content">
            <div class="url-header">
              <span class="badge badge-${isRecommended ? 'yes' : 'decide'}">${url.recommendation}</span>
              <span class="badge badge-score">Score: ${url.score}</span>
              ${url.page_type}
            </div>
            <div class="url-link">${url.url}</div>
            <div class="url-reasoning">${url.reasoning}</div>
          </div>
        </label>
      `;
      
      urlList.appendChild(itemDiv);
      
      if (checked) selectedCount++;
    });
    
    // Update count display
    document.getElementById('count').textContent = selectedCount;
    
    // Handle checkbox changes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const item = e.target.closest('.url-item');
        
        if (e.target.checked) {
          item.classList.add('selected');
          selectedCount++;
        } else {
          item.classList.remove('selected');
          selectedCount--;
        }
        
        document.getElementById('count').textContent = selectedCount;
      });
    });
    
    // Handle form submission
    document.getElementById('checkpoint-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      // Collect selected URLs
      const formData = new FormData(e.target);
      const selectedUrls = [];
      
      data.urls.forEach((url, index) => {
        if (formData.get(`url_${index}`)) {
          selectedUrls.push(url.url);
        }
      });
      
      // Prepare submission payload
      const payload = {
        session_id: data.session_id,
        selected_urls: selectedUrls,
        approved_at: new Date().toISOString(),
        total_available: data.urls.length,
        total_selected: selectedUrls.length
      };
      
      try {
        // Send to WF2 webhook
        const response = await fetch('https://n8n.app.everythink.pro/webhook/checkpoint1-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          // Success message
          document.querySelector('.container').innerHTML = `
            <div class="success-message">
              <h1>‚úÖ Submission Successful!</h1>
              <p>Your selection of <strong>${selectedUrls.length} URLs</strong> has been received.</p>
              <p>Analysis will continue shortly. You'll receive another email when it's complete.</p>
              <br>
              <p style="color: #999; font-size: 14px;">Session ID: ${data.session_id}</p>
            </div>
          `;
        } else {
          throw new Error('Server returned error status');
        }
      } catch (error) {
        console.error('Submission error:', error);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Selection ‚Üí';
        alert('‚ùå Submission failed. Please try again or contact support.');
      }
    });
  </script>
</body>
</html>
